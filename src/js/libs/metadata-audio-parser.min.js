"use strict"
function parse_audio_metadata(e,t,n){function i(e){var n={}
n[h]=e.getASCIIText(3,30)||f[h],n[v]=e.getASCIIText(33,30),n[T]=e.getASCIIText(63,30),n[g]=e.getASCIIText(93,4),n[x]=e.getASCIIText(97,30)||f[x]
for(var i in n){var r=n[i].indexOf("\x00")
f[i]=-1!==r?n[i].substring(0,r):n[i]}f[I]=0===e.getUint8(125)?e.getUint8(126):f[I]||0,f[U]=B[e.getUint8(127)]||"",t(f)}function r(n){function i(e){for(d&&e.advance(e.readUnsignedInt());e.index<e.byteLength;){var n,i,o
if(0===e.getUint8(e.index))break
switch(s){case 2:n=e.readASCIIText(3),i=e.readUint24(),o=0
break
case 3:n=e.readASCIIText(4),i=e.readUnsignedInt(),o=e.readUnsignedShort()
break
case 4:n=e.readASCIIText(4),i=e.readID3Uint28BE(),o=e.readUnsignedShort()}var u=e.index+i,c=E[n]
if(c)if(0===(255&o)){try{var l=null
switch(n){case"TIT2":case"TT2":case"TPE1":case"TP1":case"TALB":case"TAL":case"TORY":case"TDOR":case"TYER":case"TYE":case"TDRC":l=a(e,i)
break
case"TRCK":case"TRK":case"PCNT":case"CNT":l=parseInt(a(e,i))
break
case"APIC":case"PIC":l=r(e,i,n)
break
case"TCON":case"TCO":l=a(e,i)||"",l=new String(l).replace(/^\(?([0-9]+)\)?$/,function(e,t){return B[parseInt(t)]})
break
case"POPM":case"POP":l=a(e,i,0),isNaN(parseInt(l))&&(l=e.readUnsignedByte()),l=0==l?0:64>l?1:128>l?2:192>l?3:255>l?4:5}l&&(f[c]=l)}catch(g){console.warn("Error parsing mp3 metadata tag",n,":",g)}e.index=u}else console.warn("Skipping",n,"tag with flags",o),e.index=u
else e.index=u}t(f)}function r(t,n,i){var r,s=t.index,o=t.readUnsignedByte()
if("PIC"===i)switch(t.readASCIIText(3)){case"JPG":r="image/jpeg"
break
case"PNG":r="image/png"}else r=t.readNullTerminatedLatin1Text(n-1)
var d=(t.readUnsignedByte(),a(t,n-(t.index-s),o),t.sliceOffset+t.viewOffset+t.index),u=n-(t.index-s)
return e.slice(d,d+u,r)}function a(e,t,n){switch(void 0===n&&(n=e.readUnsignedByte(),t-=1),n){case 0:return e.readNullTerminatedLatin1Text(t)
case 1:return e.readNullTerminatedUTF16Text(t,void 0)
case 2:return e.readNullTerminatedUTF16Text(t,!1)
case 3:return e.readNullTerminatedUTF8Text(t)
default:throw Error("unknown text encoding")}}n.index=3
var s=n.readUnsignedByte()
if(s>4)return console.warn("mp3 file with unknown metadata version"),void t(f)
var o=(n.readUnsignedByte(),n.readUnsignedByte()),d=0!==(64&o),u=n.readID3Uint28BE()
n.getMore(n.index,u,i)}function a(i){function r(e){e.advance(26)
var i=e.readUnsignedByte(),u=e.readUnsignedByteArray(i),g=Array.prototype.reduce.call(u,a,0)
switch(s++){case 0:switch(e.getASCIIText(e.index,4)){case"Opus":o+=1
case"vor":o+=3
case"FLA":o+=4}e.advance(g),r(e)
break
case 1:e.advance(o),g-=o
var h=e.readUnsignedInt(!0)
g-=h+4,e.advance(h),d.total=e.readUnsignedInt(!0),g-=4
default:for(;d.total>0;d.total--){if(0===d.length&&(d.length=e.readUnsignedInt(!0),g-=4),d.length>g){d.string+=e.readUTF8Text(g),d.length-=g
break}d.string+=e.readUTF8Text(d.length)
var v=d.string.split("="),T=R[v[0].toUpperCase()]
T&&v[1]&&(f[T]=v[1]),g-=d.length,d.length=0,d.string=""}if(d.total)r(e)
else if(f[w]){var I=c(f[w]),x=new Blob([I])
BlobView.get(x,0,x.size,function(e,i){i?(n(i),delete f[w]):f[w]=l(e),t(f)})}else t(f)}}function a(e,t){return e+t}var s=0,o=0,d={string:"",length:0,total:0}
BlobView.get(e,0,e.size,function(e,t){r(e)})}function s(e){function i(e){var a=e.readUnsignedByte(),s=128===(128&a),o=127&a,d=e.readUint24(!1)
e.getMore(e.viewOffset+e.index,d+4,function(e,a){if(a)return void n(a)
switch(o){case 4:var u=e.readUnsignedInt(!0)
e.advance(u)
for(var c=e.readUnsignedInt(!0);c>0;c--){var g=e.readUnsignedInt(!0),h=e.readUTF8Text(g),v=h.indexOf("="),T=h.substring(0,v).toUpperCase().replace(" ","")
T in R&&(f[R[T]]=h.substring(v+1))}r.VORBIS_COMMENT=!0
break
case 6:f.picture=l(e),r.PICTURE=!0
break
default:e.advance(d-e.index)}r.VORBIS_COMMENT&&r.PICTURE||s?t(f):i(e)})}e.seek(4)
var r={VORBIS_COMMENT:!1,PICTURE:!1}
i(e)}function o(e,t){var n=e.getASCIIText(8,4)
if(n in t)return!0
for(var i=16,r=e.getUint32(0);r>i;){var a=e.getASCIIText(i,4)
if(i+=4,a in t)return!0}return!1}function d(i){function r(e){try{var i=e.sliceOffset+e.viewOffset,s=e.readUnsignedInt(),o=e.readASCIIText(4)
0===s?s=e.blob.size-i:1===s&&(s=4294967296*e.readUnsignedInt()+e.readUnsignedInt()),"moov"===o?e.getMore(i,s,function(e){try{a(e,s),t(f)}catch(i){n(i)}}):i+s+16<=e.blob.size?e.getMore(i+s,16,r):t(f)}catch(d){n(d)}}function a(e,t){for(e.advance(8);e.index<t;){var n=e.readUnsignedInt(),i=e.readASCIIText(4),r=e.index+n-8
if("udta"===i)d(e,t),e.index=r
else if("trak"===i){e.advance(-8)
var a=s(e,"mdia")
if(a){var u=s(a,"minf")
if(u){var c=(o(u,"vmhd"),o(u,"smhd"))
if(c){var l=s(u,"stbl")
if(l){var f=s(l,"stsd")
if(f){f.advance(20)
var g=f.readASCIIText(4)
if(!(g in P))throw"Unsupported format in MP4 container: "+g}}}}}e.index=r}else e.advance(n-8)}}function s(e,t){var n=e.index,i=e.readUnsignedInt()
for(e.advance(4);e.index<n+i;){var r=e.readUnsignedInt(),a=e.readASCIIText(4)
if(a===t)return e.advance(-8),e
e.advance(r-8)}return null}function o(e,t){var n=e.index,i=s(e,t)
return e.index=n,i}function d(e,t){for(;e.index<t;){var n=e.readUnsignedInt(),i=e.readASCIIText(4)
if("meta"===i)return u(e,e.index+n-8),void(e.index=t)
e.advance(n-8)}}function u(e,t){for(e.advance(4);e.index<t;){var n=e.readUnsignedInt(),i=e.readASCIIText(4)
if("ilst"===i)return c(e,e.index+n-8),void(e.index=t)
e.advance(n-8)}}function c(e,t){for(;e.index<t;){var n=e.readUnsignedInt(),i=e.readASCIIText(4),r=e.index+n-8,a=y[i]
if(a)try{var s=l(e,r,i)
f[a]=s}catch(o){console.warn("skipping",i,":",o)}e.index=r}}function l(t,n,i){for(;t.index<n;){var r=t.readUnsignedInt(),a=t.readASCIIText(4)
if("data"===a){var s=16777215&t.readUnsignedInt()
t.advance(4)
var o=r-16
if("trkn"===i)return t.advance(2),t.readUnsignedShort()
switch(s){case 1:return t.readUTF8Text(o)
case 13:return e.slice(t.sliceOffset+t.viewOffset+t.index,t.sliceOffset+t.viewOffset+t.index+o,"image/jpeg")
case 14:return e.slice(t.sliceOffset+t.viewOffset+t.index,t.sliceOffset+t.viewOffset+t.index+o,"image/png")
default:throw Error("unexpected type in data atom")}}else t.advance(r-8)}throw Error("no data atom found")}r(i)}function u(e){ForwardLock.getKey(function(i){function r(e,i){parseAudioMetadata(e,function(e){e.locked=!0,i.vendor&&(e.vendor=i.vendor),e[h]||(e[h]=i.name),t(e)},n)}ForwardLock.unlockBlob(i,e,r,n)})}function c(e,t){function n(e){return e>64&&91>e?e-65:e>96&&123>e?e-71:e>47&&58>e?e+4:43===e?62:47===e?63:0}for(var i,r,a=e.replace(/[^A-Za-z0-9\+\/]/g,""),s=a.length,o=t?Math.ceil((3*s+1>>2)/t)*t:3*s+1>>2,d=new Uint8Array(o),u=0,c=0,l=0;s>l;l++)if(r=3&l,u|=n(a.charCodeAt(l))<<18-6*r,3===r||s-l===1){for(i=0;3>i&&o>c;i++,c++)d[c]=u>>>(16>>>i&24)&255
u=0}return d}function l(e){var t,n,i,r,a,s,o={}
o.APIC=e.readUnsignedInt(),t=e.readUnsignedInt(),n=e.readASCIIText(t),i=e.readUnsignedInt(),o.name=e.readASCIIText(i),o.width=e.readUnsignedInt(),o.height=e.readUnsignedInt(),o.depth=e.readUnsignedInt(),o.index=e.readUnsignedInt(),r=e.readUnsignedInt(),a=e.readUnsignedByteArray(r),s=new Blob([a],{type:n})
for(var d in o)s[d]=o[d]
return s}var f={},g="year",h="title",v="artist",T="album",I="tracknum",x="comment",U="genre",w="picture",C="rated",A="played"
if(f[C]=f[A]=0,n=n||function(e){console.warn(e)},e.size<128)return void n("file is empty or too small")
if(e.name){var p=(e.name.match(/[^\.]+$/)||["*"])[0],m=e.name.lastIndexOf("/"),b=e.name.lastIndexOf("."+p)||e.name.length,k=e.name.substring(0,m),S=e.name.substring(m+1,b)
switch(f[h]=S.replace(/\_/g," ").replace(/^\d*(?:\s-|\.)?\s/,""),f[I]=+(S.match(/^\d*/)||[0])[0],p){case"3gp":if("DCIM/"!==k)break
case"m4v":return void n("skipping "+p+" video file")}}var B=["Blues","Classic Rock","Country","Dance","Disco","Funk","Grunge","Hip-Hop","Jazz","Metal","New Age","Oldies","Other","Pop","R&B","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death Metal","Pranks","Soundtrack","Euro-Techno","Ambient","Trip-Hop","Vocal","Jazz+Funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound Clip","Gospel","Noise","AlternRock","Bass","Soul","Punk","Space","Meditative","Instrumental Pop","Instrumental Rock","Ethnic","Gothic","Darkwave","Techno-Industrial","Electronic","Pop-Folk","Eurodance","Dream","Southern Rock","Comedy","Cult","Gangsta Rap","Top 40","Christian Rap","Pop / Funk","Jungle","Native American","Cabaret","New Wave","Psychedelic","Rave","Showtunes","Trailer","Lo-Fi","Tribal","Acid Punk","Acid Jazz","Polka","Retro","Musical","Rock & Roll","Hard Rock","Folk","Folk-Rock","National Folk","Swing","Fast Fusion","Bebob","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic Rock","Progressive Rock","Psychedelic Rock","Symphonic Rock","Slow Rock","Big Band","Chorus","Easy Listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber Music","Sonata","Symphony","Booty Bass","Primus","Porn Groove","Satire","Slow Jam","Club","Tango","Samba","Folklore","Ballad","Power Ballad","Rhythmic Soul","Freestyle","Duet","Punk Rock","Drum Solo","A Cappella","Euro-House","Dance Hall","Goa","Drum & Bass","Club-House","Hardcore","Terror","Indie","BritPop","Negerpunk","Polsk Punk","Beat","Christian Gangsta Rap","Heavy Metal","Black Metal","Crossover","Contemporary Christian","Christian Rock","Merengue","Salsa","Thrash Metal","Anime","JPop","Synthpop","Abstract","Art Rock","Baroque","Bhangra","Big Beat","Breakbeat","Chillout","Downtempo","Dub","EBM","Eclectic","Electro","Electroclash","Emo","Experimental","Garage","Global","IDM","Illbient","Industro-Goth","Jam Band","Krautrock","Leftfield","Lounge","Math Rock","New Romantic","Nu-Breakz","Post-Punk","Post-Rock","Psytrance","Shoegaze","Space Rock","Trop Rock","World Music","Neoclassical","Audiobook","Audio Theatre","Neue Deutsche Welle","Podcast","Indie Rock","G-Funk","Dubstep","Garage Rock","Psybient"],E={TIT2:h,TT2:h,TPE1:v,TP1:v,TALB:T,TAL:T,TRCK:I,TRK:I,APIC:w,PIC:w,POPM:C,POP:C,PCNT:A,CNT:A,TORY:g,TDOR:g,TYER:g,TYE:g,TDRC:g,TCON:U,TCO:U},y={"©alb":T,"©art":v,"©ART":v,aART:v,"©nam":h,trkn:I,covr:w,Year:g},R={DATE:g,TITLE:h,ARTIST:v,ALBUM:T,TRACKNUMBER:I,COMMENTS:x,COMMENT:x,GENRE:U,METADATA_BLOCK_PICTURE:w},O={"M4A ":!0,"M4B ":!0,mp41:!0,mp42:!0,isom:!0,iso2:!0},P={mp4a:!0,samr:!0,sawb:!0,sawp:!0,alac:!0},M=Math.min(65536,e.size)
BlobView.get(e,0,M,function(c,l){if(l)return void n(l)
try{var g=c.getASCIIText(0,12)
if("LOCKED 1 "===g.substring(0,9))return void u(e)
if("ID3"===g.substring(0,3))r(c)
else if("OggS"===g.substring(0,4))a(c)
else if("fLaC"===g.substring(0,4))s(c)
else if("ftyp"===g.substring(4,8)){if(o(c,O))return void d(c)
n("Unknown MP4 file type")}else 65530===(65534&c.getUint16(0,!1))?BlobView.get(e,e.size-128,128,function(e,r){if(r)return void n(r)
try{var a=e.getASCIIText(0,3)
"TAG"===a?i(e):t(f)}catch(s){n(s)}}):n("Unplayable music file")}catch(h){console.error("parseAudioMetadata:",h,h.stack),n(h)}})}var BlobView=function(){function e(e){throw Error(e)}function t(e,t,n,i,r,a,s){this.blob=e,this.sliceOffset=t,this.sliceLength=n,this.slice=i,this.viewOffset=r,this.viewLength=a,this.littleEndian=s,this.view=new DataView(i,r,a),this.buffer=i,this.byteLength=a,this.byteOffset=r,this.index=0}return t.get=function(n,i,r,a,s){0>i&&e("negative offset"),0>r&&e("negative length"),i>n.size&&e("offset larger than blob size"),i+r>n.size&&(r=n.size-i)
var o=n.slice(i,i+r),d=new FileReader
d.readAsArrayBuffer(o),d.onloadend=function(){var e=null
d.result&&(e=new t(n,i,r,d.result,0,r,s||!1)),a(e,d.error)}},t.prototype={constructor:t,getMore:function(e,n,i){e>=this.sliceOffset&&e+n<=this.sliceOffset+this.sliceLength?i(new t(this.blob,this.sliceOffset,this.sliceLength,this.slice,e-this.sliceOffset,n,this.littleEndian)):t.get(this.blob,e,n,i,this.littleEndian)},littleEndian:function(){this.littleEndian=!0},bigEndian:function(){this.littleEndian=!1},getUint8:function(e){return this.view.getUint8(e)},getInt8:function(e){return this.view.getInt8(e)},getUint16:function(e,t){return this.view.getUint16(e,void 0!==t?t:this.littleEndian)},getInt16:function(e,t){return this.view.getInt16(e,void 0!==t?t:this.littleEndian)},getUint32:function(e,t){return this.view.getUint32(e,void 0!==t?t:this.littleEndian)},getInt32:function(e,t){return this.view.getInt32(e,void 0!==t?t:this.littleEndian)},getFloat32:function(e,t){return this.view.getFloat32(e,void 0!==t?t:this.littleEndian)},getFloat64:function(e,t){return this.view.getFloat64(e,void 0!==t?t:this.littleEndian)},readByte:function(){return this.view.getInt8(this.index++)},readUnsignedByte:function(){return this.view.getUint8(this.index++)},readShort:function(e){var t=this.view.getInt16(this.index,void 0!==e?e:this.littleEndian)
return this.index+=2,t},readUnsignedShort:function(e){var t=this.view.getUint16(this.index,void 0!==e?e:this.littleEndian)
return this.index+=2,t},readInt:function(e){var t=this.view.getInt32(this.index,void 0!==e?e:this.littleEndian)
return this.index+=4,t},readUnsignedInt:function(e){var t=this.view.getUint32(this.index,void 0!==e?e:this.littleEndian)
return this.index+=4,t},readFloat:function(e){var t=this.view.getFloat32(this.index,void 0!==e?e:this.littleEndian)
return this.index+=4,t},readDouble:function(e){var t=this.view.getFloat64(this.index,void 0!==e?e:this.littleEndian)
return this.index+=8,t},tell:function(){return this.index},remaining:function(){return this.byteLength-this.index},seek:function(t){0>t&&e("negative index"),t>this.byteLength&&e("index greater than buffer size"),this.index=t},advance:function(t){var n=this.index+t
0>n&&e("advance past beginning of buffer"),n>this.byteLength&&e("advance past end of buffer"),this.index=n},getUnsignedByteArray:function(e,t){return new Uint8Array(this.buffer,e+this.viewOffset,t)},readUnsignedByteArray:function(e){var t=new Uint8Array(this.buffer,this.index+this.viewOffset,e)
return this.index+=e,t},getBit:function(e,t){var n=this.view.getUint8(e)
return 0!==(n&1<<t)},getUint24:function(e,t){var n,i,r
return(void 0!==t?t:this.littleEndian)?(n=this.view.getUint8(e),i=this.view.getUint8(e+1),r=this.view.getUint8(e+2)):(r=this.view.getUint8(e),i=this.view.getUint8(e+1),n=this.view.getUint8(e+2)),(r<<16)+(i<<8)+n},readUint24:function(e){var t=this.getUint24(this.index,e)
return this.index+=3,t},getASCIIText:function(e,t){var n=new Uint8Array(this.buffer,e+this.viewOffset,t)
return String.fromCharCode.apply(String,n)},readASCIIText:function(e){var t=new Uint8Array(this.buffer,this.index+this.viewOffset,e)
return this.index+=e,String.fromCharCode.apply(String,t)},getUTF8Text:function(e,t){function n(){throw Error("Illegal UTF-8")}for(var i,r,a,s,o,d=e,u=e+t,c="";u>d;){var r=this.view.getUint8(d)
128>r?(c+=String.fromCharCode(r),d+=1):194>r?n():224>r?(d+1>=u&&n(),a=this.view.getUint8(d+1),(128>a||a>191)&&n(),i=((31&r)<<6)+(63&a),c+=String.fromCharCode(i),d+=2):240>r?(d+2>=u&&n(),a=this.view.getUint8(d+1),(128>a||a>191)&&n(),s=this.view.getUint8(d+2),(128>s||s>191)&&n(),i=((15&r)<<12)+((63&a)<<6)+(63&s),c+=String.fromCharCode(i),d+=3):245>r?(d+3>=u&&n(),a=this.view.getUint8(d+1),(128>a||a>191)&&n(),s=this.view.getUint8(d+2),(128>s||s>191)&&n(),o=this.view.getUint8(d+3),(128>o||o>191)&&n(),i=((7&r)<<18)+((63&a)<<12)+((63&s)<<6)+(63&o),i-=65536,c+=String.fromCharCode(55296+((1047552&i)>>>10)),c+=String.fromCharCode(56320+(1023&i)),d+=4):n()}return c},readUTF8Text:function(e){try{return this.getUTF8Text(this.index,e)}finally{this.index+=e}},getID3Uint28BE:function(e){var t=127&this.view.getUint8(e),n=127&this.view.getUint8(e+1),i=127&this.view.getUint8(e+2),r=127&this.view.getUint8(e+3)
return t<<21|n<<14|i<<7|r},readID3Uint28BE:function(){var e=this.getID3Uint28BE(this.index)
return this.index+=4,e},readNullTerminatedLatin1Text:function(e){for(var t="",n=unescape("%u0402%u0403%u201A%u0453%u201E%u2026%u2020%u2021%u20AC%u2030%u0409%u2039%u040A%u040C%u040B%u040F%u0452%u2018%u2019%u201C%u201D%u2022%u2013%u2014%u0000%u2122%u0459%u203A%u045A%u045C%u045B%u045F%u00A0%u040E%u045E%u0408%u00A4%u0490%u00A6%u00A7%u0401%u00A9%u0404%u00AB%u00AC%u00AD%u00AE%u0407%u00B0%u00B1%u0406%u0456%u0491%u00B5%u00B6%u00B7%u0451%u2116%u0454%u00BB%u0458%u0405%u0455%u0457"),i=function(e){return e>=192&&255>=e?String.fromCharCode(e-192+1040):e>=128&&191>=e?n.charAt(e-128):String.fromCharCode(e)},r=0;e>r;r++){var a=this.view.getUint8(this.index+r)
if(0===a){r++
break}t+=i(a)}return this.index+=r,t},readNullTerminatedUTF8Text:function(e){for(var t=0;e>t&&0!==this.view.getUint8(this.index+t);t++);var n=this.readUTF8Text(t)
return e>t&&this.advance(1),n},readNullTerminatedUTF16Text:function(e,t){if(null==t){var n=this.readUnsignedShort()
e-=2,t=65279===n?!1:!0}for(var i="",r=0;e>r;r+=2){var a=this.getUint16(this.index+r,t)
if(0===a){r+=2
break}i+=String.fromCharCode(a)}return this.index+=r,i}},{get:t.get}}()
