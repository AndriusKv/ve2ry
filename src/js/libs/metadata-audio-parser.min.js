"use strict";function parse_audio_metadata(a,b,c){function A(a){var c={};c[f]=a.getASCIIText(3,30)||d[f],c[g]=a.getASCIIText(33,30),c[h]=a.getASCIIText(63,30),c[e]=a.getASCIIText(93,4),c[j]=a.getASCIIText(97,30)||d[j];for(var l in c){var m=c[l].indexOf("\0");d[l]=m!==-1?c[l].substring(0,m):c[l]}d[i]=0===a.getUint8(125)?a.getUint8(126):d[i]||0,d[k]=t[a.getUint8(127)]||"",b(d)}function B(c){function j(a){for(h&&a.advance(a.readUnsignedInt());a.index<a.byteLength;){var c,f,g;if(0===a.getUint8(a.index))break;switch(e){case 2:c=a.readASCIIText(3),f=a.readUint24(),g=0;break;case 3:c=a.readASCIIText(4),f=a.readUnsignedInt(),g=a.readUnsignedShort();break;case 4:c=a.readASCIIText(4),f=a.readID3Uint28BE(),g=a.readUnsignedShort()}var i=a.index+f,j=u[c];if(j)if(0===(255&g)){try{var m=null;switch(c){case"TIT2":case"TT2":case"TPE1":case"TP1":case"TALB":case"TAL":case"TORY":case"TDOR":case"TYER":case"TYE":case"TDRC":m=l(a,f);break;case"TRCK":case"TRK":case"PCNT":case"CNT":m=parseInt(l(a,f));break;case"APIC":case"PIC":m=k(a,f,c);break;case"TCON":case"TCO":m=l(a,f)||"",m=new String(m).replace(/^\(?([0-9]+)\)?$/,function(a,b){return t[parseInt(b)]});break;case"POPM":case"POP":m=l(a,f,0),isNaN(parseInt(m))&&(m=a.readUnsignedByte()),m=0==m?0:m<64?1:m<128?2:m<192?3:m<255?4:5}m&&(d[j]=m)}catch(a){console.warn("Error parsing mp3 metadata tag",c,":",a)}a.index=i}else console.warn("Skipping",c,"tag with flags",g),a.index=i;else a.index=i}b(d)}function k(b,c,d){var g,e=b.index,f=b.readUnsignedByte();if("PIC"===d)switch(b.readASCIIText(3)){case"JPG":g="image/jpeg";break;case"PNG":g="image/png"}else g=b.readNullTerminatedLatin1Text(c-1);var j=(b.readUnsignedByte(),l(b,c-(b.index-e),f),b.sliceOffset+b.viewOffset+b.index),k=c-(b.index-e);return a.slice(j,j+k,g)}function l(a,b,c){switch(void 0===c&&(c=a.readUnsignedByte(),b-=1),c){case 0:return a.readNullTerminatedLatin1Text(b);case 1:return a.readNullTerminatedUTF16Text(b,void 0);case 2:return a.readNullTerminatedUTF16Text(b,!1);case 3:return a.readNullTerminatedUTF8Text(b);default:throw Error("unknown text encoding")}}c.index=3;var e=c.readUnsignedByte();if(e>4)return console.warn("mp3 file with unknown metadata version"),void b(d);var g=(c.readUnsignedByte(),c.readUnsignedByte()),h=0!==(64&g),i=c.readID3Uint28BE();c.getMore(c.index,i,j)}function C(e){function f(a,b){var c=a.getUint8(26+b),d=a.getUnsignedByteArray(27+b,c),e=Array.prototype.reduce.call(d,g,0);return{numberSegments:c,segmentLengths:d,sectionLength:27+b+c+e,offsetLength:27+b+c,length:e}}function g(a,b){return a+b}switch(e.getASCIIText(28,4)){case"Opus":case"FLA":case"vor":break;default:return c("malformed ogg comment packet")}BlobView.get(a,0,a.size,function(a,g){if(g)return void c(g);for(var h={string:"",length:0,total:0},i={0:f(e,0)},j=0;i[j];){j++;try{i[j]=f(a,i[j-1].sectionLength);var k=i[j].offsetLength;if(1===j){var m=a.getInt8(k);switch(k+=4,m){case 79:k+=1;case 3:k+=3}var n=a.getUint32(k,!0);k+=4+n,h.total=a.getInt8(k),k+=4}for(;h.total>0;h.total--){0===h.length&&(h.length=a.getUint32(k,!0),k+=4);var o=i[j].sectionLength-k;if(h.length>o){h.string+=a.getUTF8Text(k,o),h.length-=o;break}h.string+=a.getUTF8Text(k,h.length);var p=h.string.split("="),q=w[p[0].toUpperCase()];q&&p[1]&&(d[q]=p[1]),k+=h.length,h.length=0,h.string=""}if(!h.total)break}catch(a){console.warn(a);break}}if(d[l]){var r=H(d[l]),s=new Blob([r]);I(s)}else b(d)})}function D(a){function f(a){switch(a.block_type){case 4:i(a.view),c=!0;break;case 6:d.picture=new Blob([a.view.buffer]),e=!0}return!c||!e}function g(a){return h(a).then(a=>{f(a)&&!a.last?(a.view.advance(a.length-a.view.index),g(a.view)):d[l]?I(d[l]):b(d)})}function h(a){return new Promise(function(b,c){var d=a.readUnsignedByte(),e=128===(128&d),f=127&d,g=a.readUint24(!1);a.getMore(a.viewOffset+a.index,g+4,function(a,d){return d?void c(d):void b({last:e,block_type:f,length:g,view:a})})})}function i(a){var b=a.readUnsignedInt(!0);a.advance(b);for(var c=a.readUnsignedInt(!0),e=0;e<c;e++)try{var f=j(a);f&&(d[f.field]=f.value)}catch(a){console.warn("Error parsing vorbis comment",a)}}function j(a){var b=a.readUnsignedInt(!0),c=a.readUTF8Text(b),d=c.indexOf("=");if(d===-1)throw new Error("missing delimiter in comment");var e=c.substring(0,d).toUpperCase().replace(" ",""),f=w[e];if(f){var g=c.substring(d+1);return{field:f,value:g}}return null}a.seek(4);var c=!1,e=!1;g(a)}function E(a,b){var c=a.getASCIIText(8,4);if(c in b)return!0;for(var d=16,e=a.getUint32(0);d<e;){var f=a.getASCIIText(d,4);if(d+=4,f in b)return!0}return!1}function F(e){function f(a){try{var e=a.sliceOffset+a.viewOffset,h=a.readUnsignedInt(),i=a.readASCIIText(4);0===h?h=a.blob.size-e:1===h&&(h=4294967296*a.readUnsignedInt()+a.readUnsignedInt()),"moov"===i?a.getMore(e,h,function(a){try{g(a,h),b(d)}catch(a){c(a)}}):e+h+16<=a.blob.size?a.getMore(e+h,16,f):b(d)}catch(a){c(a)}}function g(a,b){for(a.advance(8);a.index<b;){var c=a.readUnsignedInt(),d=a.readASCIIText(4),e=a.index+c-8;if("udta"===d)j(a,b),a.index=e;else if("trak"===d){a.advance(-8);var f=h(a,"mdia");if(f){var g=h(f,"minf");if(g){var l=(i(g,"vmhd"),i(g,"smhd"));if(l){var m=h(g,"stbl");if(m){var n=h(m,"stsd");if(n){n.advance(20);var o=n.readASCIIText(4);if(!(o in y))throw"Unsupported format in MP4 container: "+o}}}}}a.index=e}else a.advance(c-8)}}function h(a,b){var c=a.index,d=a.readUnsignedInt();for(a.advance(4);a.index<c+d;){var e=a.readUnsignedInt(),f=a.readASCIIText(4);if(f===b)return a.advance(-8),a;a.advance(e-8)}return null}function i(a,b){var c=a.index,d=h(a,b);return a.index=c,d}function j(a,b){for(;a.index<b;){var c=a.readUnsignedInt(),d=a.readASCIIText(4);if("meta"===d)return k(a,a.index+c-8),void(a.index=b);a.advance(c-8)}}function k(a,b){for(a.advance(4);a.index<b;){var c=a.readUnsignedInt(),d=a.readASCIIText(4);if("ilst"===d)return l(a,a.index+c-8),void(a.index=b);a.advance(c-8)}}function l(a,b){for(;a.index<b;){var c=a.readUnsignedInt(),e=a.readASCIIText(4),f=a.index+c-8,g=v[e];if(g)try{var h=m(a,f,e);d[g]=h}catch(a){console.warn("skipping",e,":",a)}a.index=f}}function m(b,c,d){for(;b.index<c;){var e=b.readUnsignedInt(),f=b.readASCIIText(4);if("data"===f){var g=16777215&b.readUnsignedInt();b.advance(4);var h=e-16;if("trkn"===d)return b.advance(2),b.readUnsignedShort();switch(g){case 1:return b.readUTF8Text(h);case 13:return a.slice(b.sliceOffset+b.viewOffset+b.index,b.sliceOffset+b.viewOffset+b.index+h,"image/jpeg");case 14:return a.slice(b.sliceOffset+b.viewOffset+b.index,b.sliceOffset+b.viewOffset+b.index+h,"image/png");default:throw Error("unexpected type in data atom")}}else b.advance(e-8)}throw Error("no data atom found")}f(e)}function G(a){ForwardLock.getKey(function(d){function e(a,d){parseAudioMetadata(a,function(a){a.locked=!0,d.vendor&&(a.vendor=d.vendor),a[f]||(a[f]=d.name),b(a)},c)}ForwardLock.unlockBlob(d,a,e,c)})}function H(a,b){function c(a){return a>64&&a<91?a-65:a>96&&a<123?a-71:a>47&&a<58?a+4:43===a?62:47===a?63:0}for(var h,i,d=a.replace(/[^A-Za-z0-9\+\/]/g,""),e=d.length,f=b?Math.ceil((3*e+1>>2)/b)*b:3*e+1>>2,g=new Uint8Array(f),j=0,k=0,l=0;l<e;l++)if(i=3&l,j|=c(d.charCodeAt(l))<<18-6*i,3===i||e-l===1){for(h=0;h<3&&k<f;h++,k++)g[k]=j>>>(16>>>h&24)&255;j=0}return g}function I(a){BlobView.get(a,0,a.size,function(a,e){if(e)return void c(e);var f,g,h,i,j,k={};k.APIC=a.readUnsignedInt(),f=a.readUnsignedInt(),g=a.readASCIIText(f),h=a.readUnsignedInt(),k.name=a.readASCIIText(h),k.width=a.readUnsignedInt(),k.height=a.readUnsignedInt(),k.depth=a.readUnsignedInt(),k.index=a.readUnsignedInt(),i=a.readUnsignedInt(),j=a.readUnsignedByteArray(i),d[l]=new Blob([j],{type:g});for(var m in k)d[l][m]=k[m];b(d)})}var d={},e="year",f="title",g="artist",h="album",i="tracknum",j="comment",k="genre",l="picture",m="rated",n="played";if(d[m]=d[n]=0,c=c||function(a){console.warn(a)},a.size<128)return void c("file is empty or too small");if(a.name){var o=(a.name.match(/[^\.]+$/)||["*"])[0],p=a.name.lastIndexOf("/"),q=a.name.lastIndexOf("."+o)||a.name.length,r=a.name.substring(0,p),s=a.name.substring(p+1,q);switch(d[f]=s.replace(/\_/g," ").replace(/^\d*(?:\s-|\.)?\s/,"").replace(/\s(?:\[|\(|\{).+(?:\)|\]|\})/,""),d[j]=(s.match(/(?:\[|\(|\{).+(?:\)|\]|\})/)||[""])[0],d[i]=Number((s.match(/^\d*/)||[0])[0]),o){case"3gp":if("DCIM/"!==r)break;case"m4v":return void c("skipping "+o+" video file")}}var t=["Blues","Classic Rock","Country","Dance","Disco","Funk","Grunge","Hip-Hop","Jazz","Metal","New Age","Oldies","Other","Pop","R&B","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death Metal","Pranks","Soundtrack","Euro-Techno","Ambient","Trip-Hop","Vocal","Jazz+Funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound Clip","Gospel","Noise","AlternRock","Bass","Soul","Punk","Space","Meditative","Instrumental Pop","Instrumental Rock","Ethnic","Gothic","Darkwave","Techno-Industrial","Electronic","Pop-Folk","Eurodance","Dream","Southern Rock","Comedy","Cult","Gangsta Rap","Top 40","Christian Rap","Pop / Funk","Jungle","Native American","Cabaret","New Wave","Psychedelic","Rave","Showtunes","Trailer","Lo-Fi","Tribal","Acid Punk","Acid Jazz","Polka","Retro","Musical","Rock & Roll","Hard Rock","Folk","Folk-Rock","National Folk","Swing","Fast Fusion","Bebob","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic Rock","Progressive Rock","Psychedelic Rock","Symphonic Rock","Slow Rock","Big Band","Chorus","Easy Listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber Music","Sonata","Symphony","Booty Bass","Primus","Porn Groove","Satire","Slow Jam","Club","Tango","Samba","Folklore","Ballad","Power Ballad","Rhythmic Soul","Freestyle","Duet","Punk Rock","Drum Solo","A Cappella","Euro-House","Dance Hall","Goa","Drum & Bass","Club-House","Hardcore","Terror","Indie","BritPop","Negerpunk","Polsk Punk","Beat","Christian Gangsta Rap","Heavy Metal","Black Metal","Crossover","Contemporary Christian","Christian Rock","Merengue","Salsa","Thrash Metal","Anime","JPop","Synthpop","Abstract","Art Rock","Baroque","Bhangra","Big Beat","Breakbeat","Chillout","Downtempo","Dub","EBM","Eclectic","Electro","Electroclash","Emo","Experimental","Garage","Global","IDM","Illbient","Industro-Goth","Jam Band","Krautrock","Leftfield","Lounge","Math Rock","New Romantic","Nu-Breakz","Post-Punk","Post-Rock","Psytrance","Shoegaze","Space Rock","Trop Rock","World Music","Neoclassical","Audiobook","Audio Theatre","Neue Deutsche Welle","Podcast","Indie Rock","G-Funk","Dubstep","Garage Rock","Psybient"],u={TIT2:f,TT2:f,TPE1:g,TP1:g,TALB:h,TAL:h,TRCK:i,TRK:i,APIC:l,PIC:l,POPM:m,POP:m,PCNT:n,CNT:n,TORY:e,TDOR:e,TYER:e,TYE:e,TDRC:e,TCON:k,TCO:k},v={"©alb":h,"©art":g,"©ART":g,aART:g,"©nam":f,trkn:i,covr:l,Year:e},w={DATE:e,TITLE:f,ARTIST:g,ALBUM:h,TRACKNUMBER:i,COMMENTS:j,COMMENT:j,GENRE:k,METADATA_BLOCK_PICTURE:l},x={"M4A ":!0,"M4B ":!0,mp41:!0,mp42:!0,isom:!0,iso2:!0},y={mp4a:!0,samr:!0,sawb:!0,sawp:!0,alac:!0},z=Math.min(65536,a.size);BlobView.get(a,0,z,function(e,f){if(f)return void c(f);try{var g=e.getASCIIText(0,12);if("LOCKED 1 "===g.substring(0,9))return void G(a);if("ID3"===g.substring(0,3))B(e);else if("OggS"===g.substring(0,4))C(e);else if("fLaC"===g.substring(0,4))D(e);else if("ftyp"===g.substring(4,8)){if(E(e,x))return void F(e);c("Unknown MP4 file type")}else 65530===(65534&e.getUint16(0,!1))?BlobView.get(a,a.size-128,128,function(a,e){if(e)return void c(e);try{var f=a.getASCIIText(0,3);"TAG"===f?A(a):b(d)}catch(a){c(a)}}):c("Unplayable music file")}catch(a){console.error("parseAudioMetadata:",a,a.stack),c(a)}})}var BlobView=function(){function a(a){throw Error(a)}function b(a,b,c,d,e,f,g){this.blob=a,this.sliceOffset=b,this.sliceLength=c,this.slice=d,this.viewOffset=e,this.viewLength=f,this.littleEndian=g,this.view=new DataView(d,e,f),this.buffer=d,this.byteLength=f,this.byteOffset=e,this.index=0}return b.get=function(c,d,e,f,g){d<0&&a("negative offset"),e<0&&a("negative length"),d>c.size&&a("offset larger than blob size"),d+e>c.size&&(e=c.size-d);var h=c.slice(d,d+e),i=new FileReader;i.readAsArrayBuffer(h),i.onloadend=function(){var a=null;i.result&&(a=new b(c,d,e,i.result,0,e,g||!1)),f(a,i.error)}},b.prototype={constructor:b,getMore:function(a,c,d){a>=this.sliceOffset&&a+c<=this.sliceOffset+this.sliceLength?d(new b(this.blob,this.sliceOffset,this.sliceLength,this.slice,a-this.sliceOffset,c,this.littleEndian)):b.get(this.blob,a,c,d,this.littleEndian)},littleEndian:function(){this.littleEndian=!0},bigEndian:function(){this.littleEndian=!1},getUint8:function(a){return this.view.getUint8(a)},getInt8:function(a){return this.view.getInt8(a)},getUint16:function(a,b){return this.view.getUint16(a,void 0!==b?b:this.littleEndian)},getInt16:function(a,b){return this.view.getInt16(a,void 0!==b?b:this.littleEndian)},getUint32:function(a,b){return this.view.getUint32(a,void 0!==b?b:this.littleEndian)},getInt32:function(a,b){return this.view.getInt32(a,void 0!==b?b:this.littleEndian)},getFloat32:function(a,b){return this.view.getFloat32(a,void 0!==b?b:this.littleEndian)},getFloat64:function(a,b){return this.view.getFloat64(a,void 0!==b?b:this.littleEndian)},readByte:function(){return this.view.getInt8(this.index++)},readUnsignedByte:function(){return this.view.getUint8(this.index++)},readShort:function(a){var b=this.view.getInt16(this.index,void 0!==a?a:this.littleEndian);return this.index+=2,b},readUnsignedShort:function(a){var b=this.view.getUint16(this.index,void 0!==a?a:this.littleEndian);return this.index+=2,b},readInt:function(a){var b=this.view.getInt32(this.index,void 0!==a?a:this.littleEndian);return this.index+=4,b},readUnsignedInt:function(a){var b=this.view.getUint32(this.index,void 0!==a?a:this.littleEndian);return this.index+=4,b},readFloat:function(a){var b=this.view.getFloat32(this.index,void 0!==a?a:this.littleEndian);return this.index+=4,b},readDouble:function(a){var b=this.view.getFloat64(this.index,void 0!==a?a:this.littleEndian);return this.index+=8,b},tell:function(){return this.index},remaining:function(){return this.byteLength-this.index},seek:function(b){b<0&&a("negative index"),b>this.byteLength&&a("index greater than buffer size"),this.index=b},advance:function(b){var c=this.index+b;c<0&&a("advance past beginning of buffer"),c>this.byteLength&&a("advance past end of buffer"),this.index=c},getUnsignedByteArray:function(a,b){return new Uint8Array(this.buffer,a+this.viewOffset,b)},readUnsignedByteArray:function(a){var b=new Uint8Array(this.buffer,this.index+this.viewOffset,a);return this.index+=a,b},getBit:function(a,b){var c=this.view.getUint8(a);return 0!==(c&1<<b)},getUint24:function(a,b){var c,d,e;return(void 0!==b?b:this.littleEndian)?(c=this.view.getUint8(a),d=this.view.getUint8(a+1),e=this.view.getUint8(a+2)):(e=this.view.getUint8(a),d=this.view.getUint8(a+1),c=this.view.getUint8(a+2)),(e<<16)+(d<<8)+c},readUint24:function(a){var b=this.getUint24(this.index,a);return this.index+=3,b},getASCIIText:function(a,b){var c=new Uint8Array(this.buffer,a+this.viewOffset,b);return String.fromCharCode.apply(String,c)},readASCIIText:function(a){var b=new Uint8Array(this.buffer,this.index+this.viewOffset,a);return this.index+=a,String.fromCharCode.apply(String,b)},getUTF8Text:function(a,b){function c(){throw new Error("Illegal UTF-8")}for(var f,h,i,j,k,d=a,e=a+b,g="";d<e;){var h=this.view.getUint8(d);h<128?(g+=String.fromCharCode(h),d+=1):h<194?c():h<224?(d+1>=e&&c(),i=this.view.getUint8(d+1),(i<128||i>191)&&c(),f=((31&h)<<6)+(63&i),g+=String.fromCharCode(f),d+=2):h<240?(d+2>=e&&c(),i=this.view.getUint8(d+1),(i<128||i>191)&&c(),j=this.view.getUint8(d+2),(j<128||j>191)&&c(),f=((15&h)<<12)+((63&i)<<6)+(63&j),g+=String.fromCharCode(f),d+=3):h<245?(d+3>=e&&c(),i=this.view.getUint8(d+1),(i<128||i>191)&&c(),j=this.view.getUint8(d+2),(j<128||j>191)&&c(),k=this.view.getUint8(d+3),(k<128||k>191)&&c(),f=((7&h)<<18)+((63&i)<<12)+((63&j)<<6)+(63&k),f-=65536,g+=String.fromCharCode(55296+((1047552&f)>>>10)),g+=String.fromCharCode(56320+(1023&f)),d+=4):c()}return g},readUTF8Text:function(a){try{return this.getUTF8Text(this.index,a)}finally{this.index+=a}},getID3Uint28BE:function(a){var b=127&this.view.getUint8(a),c=127&this.view.getUint8(a+1),d=127&this.view.getUint8(a+2),e=127&this.view.getUint8(a+3);return b<<21|c<<14|d<<7|e},readID3Uint28BE:function(){var a=this.getID3Uint28BE(this.index);return this.index+=4,a},readNullTerminatedLatin1Text:function(a){for(var b="",c=unescape("%u0402%u0403%u201A%u0453%u201E%u2026%u2020%u2021%u20AC%u2030%u0409%u2039%u040A%u040C%u040B%u040F%u0452%u2018%u2019%u201C%u201D%u2022%u2013%u2014%u0000%u2122%u0459%u203A%u045A%u045C%u045B%u045F%u00A0%u040E%u045E%u0408%u00A4%u0490%u00A6%u00A7%u0401%u00A9%u0404%u00AB%u00AC%u00AD%u00AE%u0407%u00B0%u00B1%u0406%u0456%u0491%u00B5%u00B6%u00B7%u0451%u2116%u0454%u00BB%u0458%u0405%u0455%u0457"),d=function(a){return a>=192&&a<=255?String.fromCharCode(a-192+1040):a>=128&&a<=191?c.charAt(a-128):String.fromCharCode(a)},e=0;e<a;e++){var f=this.view.getUint8(this.index+e);if(0===f){e++;break}b+=d(f)}return this.index+=e,b},readNullTerminatedUTF8Text:function(a){for(var b=0;b<a&&0!==this.view.getUint8(this.index+b);b++);var c=this.readUTF8Text(b);return b<a&&this.advance(1),c},readNullTerminatedUTF16Text:function(a,b){if(null==b){var c=this.readUnsignedShort();a-=2,b=65279!==c}for(var d="",e=0;e<a;e+=2){var f=this.getUint16(this.index+e,b);if(0===f){e+=2;break}d+=String.fromCharCode(f)}return this.index+=e,d}},{get:b.get}}();