importScripts("./libs/dexie.min.js");const db=new Dexie("veery");function getPlaylist(a){return db.playlists.where("id").equals(a)}function addTracks({id:a,tracks:t}){getPlaylist(a).modify((a,e)=>{e.value.tracks=e.value.tracks.concat(t)})}function updateTracks({id:a,tracks:t}){getPlaylist(a).modify((a,e)=>{e.value.tracks=t})}function removeTracks({id:a,tracks:t}){getPlaylist(a).modify((a,e)=>{e.value.tracks=e.value.tracks.filter(a=>!t.some(({name:t})=>t===a.name))})}function updatePlaylistProps(a){getPlaylist(a.id).modify((t,e)=>{Object.keys(a).forEach(t=>{e.value[t]=a[t]})})}async function syncArtworks(){const[a,t]=await Promise.all([db.artworks.toArray(),db.playlists.toArray()]),e=t.reduce((a,t)=>a.concat(t.tracks),[]).map(a=>a.artworkId).reduce((a,t)=>(a[t]=a[t]?a[t]+1:1,a),{}),s=a.filter(a=>!e[a.id]).map(a=>a.id);db.artworks.bulkDelete(s)}db.version(1).stores({playlists:"id",artworks:"id"}),async function(){const[a,t]=await Promise.all([db.playlists.toArray(),db.artworks.toArray()]);postMessage({artworks:t,playlists:a.sort((a,t)=>a.createdAt>t.createdAt?1:a.createdAt<t.createdAt?-1:0)})}(),self.onmessage=function({data:{action:a,artworks:t,playlist:e}}){db.transaction("rw",db.artworks,db.playlists,()=>{"create-playlist"===a?db.playlists.put(e):"delete-playlist"===a?getPlaylist(e.id).delete():"add-tracks"===a?addTracks(e):"update-tracks"===a?updateTracks(e):"remove-tracks"===a?removeTracks(e):updatePlaylistProps(e),t&&db.artworks.bulkPut(Object.keys(t).map(a=>{const e=t[a];return e.image.original.blob&&delete e.image.original.url,e.image.small&&(e.image.small.blob?delete e.image.small.url:delete e.image.small),e})),syncArtworks()}).catch(a=>{console.log(a)})};