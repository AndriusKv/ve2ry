importScripts("./libs/dexie.min.js");const a=new Dexie("veery");function t(t){return a.playlists.where("id").equals(t)}a.version(1).stores({playlists:"id",artworks:"id"}),async function(){const[t,e]=await Promise.all([a.playlists.toArray(),a.artworks.toArray()]);postMessage({artworks:e,playlists:t.sort(((a,t)=>a.createdAt>t.createdAt?1:a.createdAt<t.createdAt?-1:0))})}(),self.onmessage=function({data:{action:e,artworks:r,playlist:s}}){a.transaction("rw",a.artworks,a.playlists,(()=>{"create-playlist"===e?a.playlists.put(s):"delete-playlist"===e?t(s.id).delete():"add-tracks"===e?function({id:a,tracks:e}){t(a).modify(((a,t)=>{t.value.tracks=t.value.tracks.concat(e)}))}(s):"update-tracks"===e?function({id:a,tracks:e}){t(a).modify(((a,t)=>{t.value.tracks=e}))}(s):"remove-tracks"===e?function({id:a,tracks:e}){t(a).modify(((a,t)=>{t.value.tracks=t.value.tracks.filter((a=>!e.some((({name:t})=>t===a.name))))}))}(s):function(a){t(a.id).modify(((t,e)=>{Object.keys(a).forEach((t=>{e.value[t]=a[t]}))}))}(s),r&&a.artworks.bulkPut(Object.keys(r).map((a=>{const t=r[a];return t.image.original.blob&&delete t.image.original.url,t.image.small&&(t.image.small.blob?delete t.image.small.url:delete t.image.small),t}))),async function(){const[t,e]=await Promise.all([a.artworks.toArray(),a.playlists.toArray()]),r=e.reduce(((a,t)=>a.concat(t.tracks)),[]).map((a=>a.artworkId)).reduce(((a,t)=>(a[t]=a[t]?a[t]+1:1,a)),{}),s=t.filter((a=>!r[a.id])).map((a=>a.id));a.artworks.bulkDelete(s)}()})).catch((a=>{console.log(a)}))};